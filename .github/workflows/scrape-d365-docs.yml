name: Scrape D365 Documentation

permissions:
  contents: write

on:
  repository_dispatch:
    types: [scrape-docs]
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Start server in background
        run: |
          node server.js > server.log 2>&1 & 
          echo $! > server.pid
          sleep 5

      - name: Wait for server readiness
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3000/health 2>/dev/null || curl -f http://localhost:3000 2>/dev/null; then
              echo "Server is ready!"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      - name: Trigger scraping → create latest CSV
        run: |
          curl -s http://localhost:3000/scrape-all -o latest-scrape.csv

      - name: Verify CSV exists
        run: |
          if [ -f latest-scrape.csv ]; then
            echo "CSV generated successfully."
          else
            echo "CSV missing!"
            exit 1
          fi

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then kill $(cat server.pid) || true; fi
          pkill -f "node server.js" || true

      - name: Prepare history folder
        run: |
          mkdir -p history
          cp latest-scrape.csv history/scrape_$(date +"%Y_%m_%d_%H_%M").csv

      - name: Keep only last 5 history files
        run: |
          cd history
          ls -t | sed -e '1,5d' | xargs -r rm -f

      - name: Generate comparison report (clean + accurate)
        run: |
          if [ $(ls history | wc -l) -ge 2 ]; then
            NEW=latest-scrape.csv
            OLD=$(ls -t history | sed -n '2p')

            echo "Comparing latest run against: $OLD"

            ### ------------------------------
            ### Added URLs
            ### ------------------------------
            echo "### Added URLs" > comparison.txt
            comm -23 <(cut -d',' -f2 "$NEW" | sort) <(cut -d',' -f2 "history/$OLD" | sort) >> comparison.txt

            ### ------------------------------
            ### Removed URLs
            ### ------------------------------
            echo "" >> comparison.txt
            echo "### Removed URLs" >> comparison.txt
            comm -13 <(cut -d',' -f2 "$NEW" | sort) <(cut -d',' -f2 "history/$OLD" | sort) >> comparison.txt

            ### ------------------------------
            ### Changed LastUpdated (REAL changes only)
            ### ------------------------------
            echo "" >> comparison.txt
            echo "### Changed LastUpdated" >> comparison.txt

            join -t',' -1 1 -2 1 \
              <(cut -d',' -f2,3 "$NEW" | sed 's/"//g' | sort -t',' -k1,1) \
              <(cut -d',' -f2,3 "history/$OLD" | sed 's/"//g' | sort -t',' -k1,1) \
              | awk -F',' '{
                  url=$1;
                  new=$2;
                  old=$3;
                  # Only show real Microsoft updates
                  if (new != old && new != "" && old != "" && new != "UNKNOWN" && old != "UNKNOWN")
                    printf "%s   %s → %s\n", url, old, new;
                }' >> comparison.txt

          else
            echo "Not enough history files to compare." > comparison.txt
          fi

      - name: Upload results as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: d365-scrape-results
          path: |
            latest-scrape.csv
            comparison.txt
            history/
          retention-days: 30

      - name: Commit CSV + history + comparison
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add latest-scrape.csv history comparison.txt || true
          git commit -m "D365 scrape update $(date)" || echo "No changes to commit"

          git pull --rebase || true
          git push || echo "Push failed"
